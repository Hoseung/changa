# Flags that can be passed during compilation
#FLAG_PRINT = -DCOSMO_PRINT=1       #enable really verbose prints
#FLAG_STATISTICS = -DCOSMO_STATS=1  # enable statistics collection
#FLAG_DEBUG = -DCOSMO_DEBUG=2       # enable debugging information
CACHE_TREE = -DCACHE_TREE          # enable processor tree inside the cache
#INTERLIST = -DINTERLIST_VER=2      # enable interaction lists
#HEXADECAPOLE = -DHEXADECAPOLE	    # use hexadecapole gravity expansions
#CELL = -DINTERLIST_VER=2 -DCELL -DCELL_PART -DCELL_NODE -DCELL_EWALD  # Cell processor offload
#FLAG_REFACTOR = -DCHANGA_REFACTOR_WALKCHECK #-DCHANGA_REFACTOR_DEBUG=2	# enable refactored code debugging information
DEFINE_FLAGS = $(FLAG_PRINT) $(FLAG_STATISTICS) $(FLAG_DEBUG) $(CACHE_TREE) $(INTERLIST) $(HEXADECAPOLE) $(CELL) $(FLAG_REFACTOR)

CHARM_PATH = @CHARM_PATH@
STRUCTURES_PATH = ../structures
CHARM_LDB_PATH = $(CHARM_PATH)/src/ck-ldb
CHARM_UTIL_PATH = $(CHARM_PATH)/src/util
CHARM_LIB_PATH = $(CHARM_PATH)/lib
METIS_SRC_PATH = $(CHARM_PATH)/src/libs/ck-libs/parmetis/METISLib

#OPTS = -g -memory charmdebug
OPTS = -O3
CXXFLAGS += $(OPTS) -I$(STRUCTURES_PATH) $(DEFINE_FLAGS) -I.. @CPPFLAGS@
LDFLAGS += $(OPTS) -L. -L../libs -language charm++ -module commlib -module RefineLB -module RefineCommLB -module GreedyLB -module GreedyCommLB -module OrbLB -module RotateLB -module MetisCosmoLB #-tracemode projections -memory charmdebug
XDR_DIR = ../rpc
XDR_OBJS = $(XDR_DIR)/xdr.o $(XDR_DIR)/xdr_float.o $(XDR_DIR)/xdr_mem.o $(XDR_DIR)/xdr_stdio.o
LDLIBS += $(STRUCTURES_PATH)/libTipsy.a @LIBS@

CHARMC = @CHARMC@

CXX = $(CHARMC)
CC = $(CXX)
AR = @AR@
CXX_DEPEND = $(CXX) -M -MM -MG $(CXXFLAGS)
CFLAGS = $(OPTS)

OBJECTS = DataManager.o Reductions.o TreePiece.o CacheManager.o Sorter.o \
	  param.o GenericTreeNode.o ParallelGravity.o Ewald.o \
	  InOutput.o cosmo.o romberg.o runge.o dumpframe.o dffuncs.o \
	  moments.o MetisCosmoLB.o ScaledORBMapBG.o ScaleTranMapBG.o \
	  TreeWalk.o Compute.o 

SRSC = Reductions.cpp DataManager.cpp Sorter.cpp TreePiece.cpp CacheManager.C \
	param.c GenericTreeNode.C ParallelGravity.cpp Ewald.C \
	InOutput.C cosmo.c romberg.c runge.c dumpframe.c dffuncs.c \
	moments.c MetisCosmoLB.C ScaledORBMapBG.C ScaleTranMapBG.C \
	TreeWalk.C Compute.C 
 

TARGET = ChaNGa
VERSION = 1.0
all: $(TARGET)

$(TARGET): $(OBJECTS) $(STRUCTURES_PATH)/libTipsy.a libmoduleMetisCosmoLB.a
	$(CHARMC) -o $(TARGET) $(LDFLAGS) $(OBJECTS) $(LDLIBS)

$(STRUCTURES_PATH)/libTipsy.a:
	cd $(STRUCTURES_PATH); $(MAKE) libTipsy.a

libmoduleMetisCosmoLB.a: MetisCosmoLB.o ScaledORBMapBG.o ScaleTranMapBG.o
	$(CHARMC) -o libmoduleMetisCosmoLB.a MetisCosmoLB.o ScaledORBMapBG.o ScaleTranMapBG.o

%.decl.h %.def.h : %.ci
	$(CHARMC) $<

%.o: Makefile

# CELL specific
# add "cell_lib.o to the OBJECTS variable below
# uncomment the following lines
#include ../../charm/tmp/Makefile.cell
#cell_lib.o: cellSPE_code.c
#	$(SPU_CC) -O3 -S -g -I../../charm/include cellSPE_code.c
#	$(SPU_CC) -O3 -c -I../../charm/include -o cellSPE_code.o cellSPE_code.c
#	$(SPU_LD) -L../../charm/lib -o cellSPE_code cellSPE_code.o $(SPERT_LIBS) -lm -lsimdmath
#	$(PPU_EMBEDSPU) spert_main cellSPE_code cell_lib.o
# End CELL specific

docs:
	doxygen $(TARGET).doxygen

DIRS = teststep

test: $(TARGET)
	for d in $(DIRS); do \
		(cd $$d && $(MAKE) test OPTS='$(OPTS)' || exit 1) || exit 1; \
	done

dist:
	mkdir $(TARGET)-$(VERSION)
	cp Makefile $(TARGET).doxygen *.h *.cpp *.ci $(TARGET)-$(VERSION)/
	tar zcf $(TARGET)-$(VERSION).tar.gz $(TARGET)-$(VERSION)
	rm -Rf $(TARGET)-$(VERSION)

clean:
	rm -f core* $(OBJECTS) *~ $(TARGET) *.decl.h *.def.h charmrun conv-host 

ref-clean:
	rm -f $(TARGET) Compute.o TreeWalk.o

# depend:
# 	$(CXX_DEPEND) $(SRSC) > Makefile.dep

# The following line is a script usable to regenerate the dependace file,
# without the inclusion of charm headers.
# ../../charm/bin/charmc  -M -MM -MG -O3 -I../structures -I../ParallelGravity -Wall  -DCOSMO_STATS=1   -DCOSMO_DEBUG=2        -DCACHE_TREE   Reductions.cpp DataManager.cpp Sorter.cpp TreePiece.cpp CacheManager.C param.c GenericTreeNode.C ParallelGravity.cpp Ewald.C InOutput.C cosmo.c romberg.c runge.c dumpframe.c dffuncs.c moments.c MetisCosmoLB.C ScaledORBMapBG.C ScaleTranMapBG.C TreeWalk.C Compute.C | while read i;do echo $i| awk -F' ' '{for (i=1;i<NF;++i) print $i" \\"}';echo;done|grep -v "charm/bin" > Makefile.dep

.PHONY: all docs dist clean depend test

include Makefile.dep
